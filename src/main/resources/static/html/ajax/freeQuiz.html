
<title>英语</title>
<meta charset="utf-8">
<link rel="stylesheet" href="../../assets/css/jquery-ui.custom.min.css" />


<style>
.input-answer {
	color : black;
}

.title2 {
	font-size: 20px;
}

.title3 {
	font-size: 20px;
	cursor: pointer;
}
</style>

<!-- ajax layout which only needs content area -->
<div class="page-header">
	<h1>
		单词小测验 <small> <i class="ace-icon fa fa-angle-double-right"></i>
			步步为营 
		</small>
	</h1>
</div>
<!-- /.page-header -->

<div class="row">
	<div class="col-xs-12">

		<div class="clearfix" >
			 <div id="headerDiv" style="margin: 5px;">
				<div class="title2" >
					<table>
						<tr>
							<td>
								名称:
							</td>
							<td>
								<span id="quizName"></span>
							</td>
						</tr>
						<tr>
							<td>
								备注:
							</td>
							<td>
								<span id="quizRemark"></span>
							</td>
						</tr>
						
					</table>
				</div>
			</div>
			 <div id="contentDiv">
				<div class="title2">Slides are loading</div>
			</div>
			 <div >
				<button class="btn btn-info" type="button" onclick="checkAnswers()">
						<i class="ace-icon fa fa-check bigger-110"></i>
						提交
				</button>
			</div>
			<div id='resultDiv'></div>
		</div>
		<!-- PAGE CONTENT ENDS -->
	</div>
	<!-- /.col -->
</div>
<!-- /.row -->

<!-- page specific plugin scripts -->

<!--[if lte IE 8]>
  <script src="../../assets/js/excanvas.min.js"></script>
<![endif]-->
<script type="text/javascript">
	var totalSize = 0;
	var qid = 0;
	var ajaxQuizData = null;
	var scripts = [ null, "../../assets/js/jquery-ui.custom.min.js",
			"../../assets/js/chosen.jquery.min.js",
			"../../assets/js/jquery.maskedinput.min.js",
			"../../assets/js/swiper3.06.min.js",
			  null ]
	ace.load_ajax_scripts(
					scripts,
					function() {
						//inline scripts related to this page
						jQuery(function($) {

							qid = GetArgsFromHref(window.location.href, "qid");
							qid = qid.replace("#page/freeQuiz", "");
							console.log("qid:" + qid);
							initQuizInfo(qid);
							var destUrl = "";
							if(qid == "") {
								destUrl = "../../getWordListForQuiz";
							} else {
								destUrl = "../../getWordListForQuiz2?id=" + qid;
							}
							
							
							$.ajax({
								type : "POST",
								url : destUrl,
								async : false,
								dataType : "json",
								success : function(data) {
									var contentsInfo = "";
									ajaxQuizData = data;
									totalSize = data.length;
									for(var i = 0; i < data.length; i++) {
										var oneWordHtml = "";
										oneWordHtml += "<div class='swiper-slide'  id='quizSpan" + i  + "'><div class='title2'><p>";
										oneWordHtml += "     <b>" + (i + 1) + "/" + totalSize + "</b>." + data[i].sentence;
										oneWordHtml += "     </p>";
										oneWordHtml += "     <p>";
										oneWordHtml += "     " + data[i].explain2;
										oneWordHtml += "     </p>";
										oneWordHtml += "     <span style='display:none;' id='answerSpan" + i  + "'>" + data[i].answer + "</span>";
										oneWordHtml += "     <span style='display:none;' id='resultSpan" + i  + "'><img src='../../assets/images/icon_bad.gif' /></span>";
										oneWordHtml += "     <span style='display:none;' id='wordIdSpan" + i + "'>" + data[i].wordId  + "</span>";
										oneWordHtml += "     </div>";
										oneWordHtml += "     </div>";
										contentsInfo += oneWordHtml;
										//	In b<input id="input1" type="input" />
									}
									
									
									$("#contentDiv").html(contentsInfo);
									
									$.mask.definitions['~']='[-A-Za-z0-9]';
									for(var i = 0; i < data.length; i++) {
										$('#input' + i).attr('size', data[i].blankCount);
										var blankChars = "";
										for(var j = 0; j < data[i].blankCount; j++) {
											blankChars += '~';
										}
										//console.log("blankChars:" + blankChars);
										$('#input' + i).mask(blankChars);
										//	In b<input id="input1" type="input" />
									}
									return;
									
									 //$('#input0').focus();
								}

							});
							
							/*
							mySwiper = new Swiper('.swiper-container', {
								pagination : '.pagination',
								paginationClickable : true,
								onSlideChangeEnd: function(swiper){
									//console.log("swiper.activeIndex:" + swiper.activeIndex);
									//$('#input' + (swiper.activeIndex)).focus();
							    }
							})
							*/
						});
					});
	
	function initQuizInfo(qid) {
		if(qid == "" || qid == 0) {
			$("#quizName").html("自由测试");
			$("#quizRemark").html("为您量身定制的测试题");
			document.title = "英语单词小测验--" + $("#quizName").html();
			return;
		}
			
		$.ajax({
			type : "POST",
			url : "../../getQuiz",
			data : {
				qId : qid
			},
			async : true,
			dataType : "json",
			success : function(data) {
				$("#quizName").html(data.name);
				$("#quizRemark").html(data.remark);
				document.title = "英语单词小测验--" + $("#quizName").html();
			},
			error : function(data) {
				alert("submit result error, please contact administrator");
			}

		});
	}
	
	function checkAnswer(inputIndex, blankCount) {
		var inputLength = $("#input" + inputIndex).val().replace(/\_/g, "").length; 
		if(inputLength == blankCount) {
			if($("#answerSpan" + inputIndex).html().toUpperCase() == $("#input" + inputIndex).val().toUpperCase()) {
				//console.log("right for" + inputIndex);
				$("#resultSpan" + inputIndex).html("<img src='../../assets/images/icon_good.gif' />");
				//console.log("mySwiper.activeIndex:" + mySwiper.activeIndex);
				//mySwiper.slideTo(mySwiper.activeIndex + 1, 1000, true);
				
			} else {
				//console.log("wrong for" + inputIndex);
				$("#resultSpan" + inputIndex).html("<img src='../../assets/images/icon_bad.gif' />");
			}
			$("#resultSpan" + inputIndex).show();
			
		}
	}
	
	function checkAnswers() {
		var rightCount = 0;
		var answerInfo = "";
		var resultInfo = "";
		for(var i = 0; i < totalSize; i++) {
			var oneWordId = $("#wordIdSpan" + i).html();
			var isAnswerRight = $("#input" + i).val().toUpperCase() == $("#answerSpan" + i).html().toUpperCase(); 
			if(isAnswerRight) {
				rightCount++;	
			}
			answerInfo += (oneWordId + ":" + (isAnswerRight ? 1 : 0));
			if(i != totalSize - 1) {
				answerInfo +=  ",";
			}
			
			
			if(!isAnswerRight) {
				var oneWordHtml = "";
				oneWordHtml += "<div style='margin-bottom:10px'><p>";
				oneWordHtml += "     <b>" + (i + 1) + "/" + totalSize + "</b>." + ajaxQuizData[i].sentence;
				oneWordHtml += "     </p>";
				oneWordHtml += "     <p>";
				oneWordHtml += "     " + ajaxQuizData[i].explain2;
				oneWordHtml += "     </p>";
				oneWordHtml += "     Right Answer: <span>" + $("#answerSpan" + i).html() + "</span>";
				oneWordHtml += "     <span class='title3' onclick='toggleFork(this, " + ajaxQuizData[i].wordId + ")'>&nbsp;<i class='ace-icon glyphicon glyphicon-star-empty'></i></span>";
				oneWordHtml += "     <br/>My    Answer: <span>" + $("#input" + i).val() + "</span>";
				oneWordHtml += "     <span>" + $("#resultSpan" + i).html() + "</span>";
				oneWordHtml += "     </div>";
				resultInfo += oneWordHtml;
			}
			
		}
		
		console.log("answerInfo:" + answerInfo);
		
		resultInfo = "Correct Rate: " + rightCount + " / " + totalSize + " = " + (rightCount / totalSize * 100) + "%" + resultInfo;
		$("#resultDiv").html(resultInfo);
		
		$("#prevBtn").hide();
		$("#nextBtn").hide();
		
		$.ajax({
			type : "POST",
			url : "../../submitAnswer",
			data : {
				answerInfo : answerInfo,
				qId : qid 
			},
			async : true,
			dataType : "json",
			success : function(data) {
				
				//rowData.tempRank = parseRank(newRank);
				//$("#grid-table").jqGrid('setRowData', id, rowData);
			},
			error : function(data) {
				alert("submit result error, please contact administrator");
			}

		});
		
	}
	
	function toggleFork(spanObj, wordId) {
		console.log("toggleFork wordId:" + wordId);
		var forkValue = $(spanObj).html().indexOf("glyphicon-star-empty") >= 0 ? 5 : 0; 
		$.ajax({
			type : "POST",
			url : "../../toggleWordFork",
			data : {
				wordId : wordId,
				forkValue : forkValue
			},
			async : true,
			dataType : "json",
			success : function(data) {
				if(data == "0") {
					alert("please login first");
				}
				else {
					if(forkValue == 0) {
						$(spanObj).html("&nbsp;<i class='ace-icon glyphicon glyphicon-star-empty'></i>");
					} else {
						$(spanObj).html("&nbsp;<i class='ace-icon glyphicon glyphicon-star'></i>");
					}					
				}
				//rowData.tempRank = parseRank(newRank);
				//$("#grid-table").jqGrid('setRowData', id, rowData);
			},
			error : function(data) {
				alert("submit result error, please contact administrator");
			}

		});
	}
	
	function GetArgsFromHref(sHref, sArgName)
	{
	      var args    = sHref.split("?");
	      var retval = "";
	    
	      if(args[0] == sHref) /*参数为空*/
	      {
	           return retval; /*无需做任何处理*/
	      }  
	      var str = args[1];
	      args = str.split("&");
	      for(var i = 0; i < args.length; i ++)
	      {
	          str = args[i];
	          var arg = str.split("=");
	          if(arg.length <= 1) continue;
	          if(arg[0] == sArgName) retval = arg[1]; 
	      }
	      return retval;
	}
	
</script>

